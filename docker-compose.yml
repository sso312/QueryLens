name: querylens-oci

services:
  api:
    build:
      context: .
      dockerfile: docker/api-proxy.Dockerfile
    container_name: querylens-api
    environment:
      - BACKEND_URL=${BACKEND_URL:-http://host.docker.internal:4000}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "${API_PORT:-80}:80"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://127.0.0.1/healthz >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always
    networks:
      - querylens-net

  frontend:
    build:
      context: .
      dockerfile: docker/frontend.Dockerfile
      args:
        - API_BASE_URL=http://api:80
        - VIS_API_BASE_URL=http://api:80
    container_name: querylens-frontend
    environment:
      - API_BASE_URL=http://api:80
      - VIS_API_BASE_URL=http://api:80
      - HOSTNAME=0.0.0.0
      - PORT=3000
    depends_on:
      api:
        condition: service_healthy
    ports:
      - "${FRONTEND_PORT:-8000}:3000"
    restart: always
    networks:
      - querylens-net

networks:
  querylens-net:
    driver: bridge
